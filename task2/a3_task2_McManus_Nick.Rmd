---
title: 'Task 2: Agglomerative Hierarchical Clustering'
author: "Nick McManus"
date: "2023-02-27"
output: html_document
---

```{r setup, include=TRUE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

library(tidyverse)   ## always
library(dendextend)  ## tanglegram to compare complete/single linkage
library(ggdendro)    ## plotting dendrogram nicely
```

# Introduction

bottom-up agglomerative clustering




**Source:** Citation: Santa Barbara Coastal LTER and J. Melack. 2019. SBC LTER: Land: Stream chemistry in the Santa Barbara Coastal drainage area, ongoing since 2000 ver 16. Environmental Data Initiative. https://doi.org/10.6073/pasta/67a558a24ceed9a0a5bf5e46ab841174. 

# Data wrangling

First, we read in the raw data and wrangle it to later perform an hierarchical clustering by complete linkages. First, any variables with high (>50%) occurrence of NAs are removed. The remaining data then undergoes a listwise deletion to return only observations with data for every variable. The average stream chemistry values are calculated by site, and then the data is scaled to more easily calculate euclidean distances.
```{r}
### read in data
stream_chem <- read_csv('sbc_lter_registered_stream_chemistry.csv') %>% 
  ## convert -999 values to NA
  na_if(-999) 


### explore the number of NAs by variable
# colSums(is.na(stream_chem))
   # site_code   timestamp_local            nh4_uM            no3_uM 
   #         0                 0               203               149 
   #    po4_uM            tdn_uM            tdp_uM            tpc_uM 
   #       167              5034              5801             16521 
   #    tpn_uM            tpp_uM    tss_mgperLiter spec_cond_uSpercm 
   #     16521             17046             14376               924 


### tpc, tpn, tpp, and tss all have more than 50% NAs.
### Let's drop them from the analysis,
### then find the average values by stream site.
stream_chem_avgs <- stream_chem %>% 
  select(!c(tpc_uM, tpn_uM, tpp_uM, tss_mgperLiter)) %>% 
  drop_na() %>% 
  group_by(site_code) %>% 
  summarize(nh4_mean = mean(nh4_uM, na.rm = TRUE),
            no3_mean = mean(no3_uM, na.rm = TRUE),
            po4_mean = mean(po4_uM, na.rm = TRUE),
            tdn_mean = mean(tdn_uM, na.rm = TRUE),
            tdp_mean = mean(tdp_uM, na.rm = TRUE),
            spec_cond_mean = mean(spec_cond_uSpercm, na.rm = TRUE))


### scale the numeric data
stream_chem_scale <- stream_chem_avgs %>% 
  select(where(is.numeric)) %>% 
  scale()

### reassign rownames based on site
rownames(stream_chem_scale) <- stream_chem_avgs$site_code
```


# Hierarchical clustering

First calculate the Euclidean distance in multivariate space between the different observations. Then, use this matrix of distances (dissimilarity matrix) to perform a complete hierarchical clustering. The results are visualized by the dendrogram in Figure 1 below.
```{r}
### calculate euc dists
euc_dist <- dist(stream_chem_scale, method = 'euclidean')

### use stats::hclust() for hierarchical clustering
stream_hc_complete <- hclust(euc_dist, method = 'complete')

### quick base plot check:
# plot(stream_hc_complete, cex = 0.6, hang = -1)
```

```{r}
### dendrogram plot
ggdendrogram(stream_hc_complete, 
             rotate = FALSE) +
  theme_minimal() +
  labs(x = "Site")

```
**Figure 1.** Dendrogram caption here.


# Complete vs. Single Linkage

Here I'll compare them with a tanglegram...




