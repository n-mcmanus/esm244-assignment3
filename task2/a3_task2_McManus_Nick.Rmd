---
title: 'Task 2: Agglomerative Hierarchical Clustering'
author: "Nick McManus"
date: "2023-02-27"
output: html_document
---

```{r setup, include=TRUE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

library(tidyverse)   ## always
library(dendextend)  ## tanglegram to compare complete/single linkage
library(ggdendro)    ## plotting dendrogram nicely
```

# Introduction

In this task, we determine the relative similarity of various Santa Barbara stream sites through an agglomerative hierarchical clustering. This bottom-up approach starts with each stream sampling site as it's own cluster, then groups sites together based on their average chemical similarity. Measured chemical parameters include dissolved nitrogen, soluble reactive phosphorous, particulate organic carbon, total suspended solids, and specific conductivity. 

This data comes from the Santa Barbara Coastal LTER, which collected water measurements from 2000 - 2018. The 13 sites are located in Santa Barbara area watersheds, stretching roughly from Gaviota State Park to downtown Santa Barbara. 

**Source:** Citation: Santa Barbara Coastal LTER and J. Melack. 2019. SBC LTER: Land: Stream chemistry in the Santa Barbara Coastal drainage area, ongoing since 2000 ver 16. Environmental Data Initiative. https://doi.org/10.6073/pasta/67a558a24ceed9a0a5bf5e46ab841174. 



# Data wrangling

First, we read in the raw data and wrangle it to later perform an hierarchical clustering by complete linkages. First, any variables with high (>50%) occurrence of NAs are removed. The remaining data then undergoes a listwise deletion to return only observations with data for every variable. The average stream chemistry values are calculated by site, and then the data is scaled to more easily calculate euclidean distances.
```{r}
### read in data
stream_chem <- read_csv('sbc_lter_registered_stream_chemistry.csv') %>% 
  ## convert -999 values to NA
  na_if(-999) 


### explore the number of NAs by variable
# colSums(is.na(stream_chem))
   # site_code   timestamp_local            nh4_uM            no3_uM 
   #         0                 0               203               149 
   #    po4_uM            tdn_uM            tdp_uM            tpc_uM 
   #       167              5034              5801             16521 
   #    tpn_uM            tpp_uM    tss_mgperLiter spec_cond_uSpercm 
   #     16521             17046             14376               924 


### tpc, tpn, tpp, and tss all have more than 50% NAs.
### Let's drop them from the analysis,
### then find the average values by stream site.
stream_chem_avgs <- stream_chem %>% 
  select(!c(tpc_uM, tpn_uM, tpp_uM, tss_mgperLiter)) %>% 
  drop_na() %>% 
  group_by(site_code) %>% 
  summarize(nh4_mean = mean(nh4_uM, na.rm = TRUE),
            no3_mean = mean(no3_uM, na.rm = TRUE),
            po4_mean = mean(po4_uM, na.rm = TRUE),
            tdn_mean = mean(tdn_uM, na.rm = TRUE),
            tdp_mean = mean(tdp_uM, na.rm = TRUE),
            spec_cond_mean = mean(spec_cond_uSpercm, na.rm = TRUE))


### scale the numeric data
stream_chem_scale <- stream_chem_avgs %>% 
  select(where(is.numeric)) %>% 
  scale()

### reassign rownames based on site
rownames(stream_chem_scale) <- stream_chem_avgs$site_code
```


# Hierarchical clustering

For a bottom-up hierarchical cluster, we first need to calculate the Euclidean distance in multivariate space between the different observations. Then, we use this matrix of distances (dissimilarity matrix) to perform a complete hierarchical clustering. The results are visualized by the dendrogram in Figure 1 below.
```{r}
### calculate euc dists
euc_dist <- dist(stream_chem_scale, method = 'euclidean')

### use stats::hclust() for hierarchical clustering
stream_hc_complete <- hclust(euc_dist, method = 'complete')

### quick base plot check:
# plot(stream_hc_complete, cex = 0.6, hang = -1)
```

```{r}
### Dendrogram plot
ggdendrogram(stream_hc_complete, 
             rotate = FALSE,
             labels = TRUE) +
  theme_classic() +
  labs(x = "Stream site",
       y = "Height") +
  scale_y_continuous(breaks = seq(0, 7, by = 1),
                     expand = c(0, 0), limits = c(0, 7)) +
  theme(
    ## x axis
    axis.line.x = element_blank(),
    axis.text.x = element_text(face = 'bold', size = 9.5),
    axis.title.x = element_text(face = 'bold', vjust = -1),
    axis.ticks.x = element_blank(),
    ## y axis
    axis.title.y = element_text(face = 'bold', vjust = 2),
    axis.text.y = element_text(face = 'bold', size = 9.5),
    axis.ticks.length.y = unit(.25, 'cm'),
    axis.line.y = element_line(linewidth = .6),
    axis.ticks.y = element_line(linewidth = .6))
plot(stream_hc_complete)
```
**Figure 1.** Dendrogram caption here.


# Complete vs. Single Linkage

Here we compare the hierarchical clustering results of complete vs. single linkages with a tanglegram. 
```{r}
### Single-linkage 
stream_hc_single <- hclust(euc_dist, method= 'single')

### Quick base plot check:
# plot(hc_single, cex = 0.9, hang = -1)

### Convert both HC's to dendrogram class
dend_complete <- as.dendrogram(stream_hc_complete)
dend_single <- as.dendrogram(stream_hc_single)

### Make a tanglegram
# tanglegram(dend_complete, dend_single)

### How similar are they?
# entanglement(dend_complete, dend_single)
# [1] 0.2774816

### Can we get the number lower (better) by untangling a bit?
# untangle(dend_complete, dend_single, method = 'step1side') %>% 
#   entanglement()
# [1] 0.1690201

### Plot the untangled tanglegram!
tangle <- untangle(dend_complete, dend_single, method = 'step1side') %>% 
  tanglegram(common_subtrees_color_branches = TRUE)
```
**Figure 2.** Ugly tangle gram with caption here. 



